var p=0;const m=document.getElementById("PODetailTable").getElementsByTagName("tbody")[0];var f=[];function s(e){new Cleave($(e),{numeral:!0,numeralDecimalMark:",",delimiter:".",numeralThousandsGroupStyle:"thousand",numeralDecimalScale:2})}function h(){var a;var e=0;for(let t=1;t<=p;t++)e+=parseInt((a=$(`#prdTotal${t}`).val())==null?void 0:a.replace(/\./g,""))||0;$("#grandTotal").val(e),s("#grandTotal")}$(function(){const e=edit||view;if(console.log(e),e){$("#poCode").val(e.po_code),$("#supplierId").append(`<option value='${e.supplier_id.id}'>${e.supplier_id.name}</option>`);const a=e.purchase_date.split(" ");$("#purchaseDate").val(a.join("T")),view&&($("#supplierId").prop("disabled",!0),$("#remarks").prop("readonly",!0));for(let t=0;t<e.po_detail.length;t++){const i=e.po_detail[t];console.log(i),u(),$(`#poDetailId${t+1}`).val(i.id),$(`#prdId${t+1}`).append(`<option value='${i.product_id.id}'>${i.product_id.name}</option>`),$(`#prdUom${t+1}`).val(i.product_id.uom),$(`#prdPurchasePrice${t+1}`).val(i.purchase_price),s($(`#prdPurchasePrice${t+1}`)),$(`#prdQuantity${t+1}`).val(i.quantity),$(`#prdTotal${t+1}`).val(i.total_price),s($(`#prdTotal${t+1}`)),view&&($(`#prdId${t+1}`).prop("disabled",!0),$(`#prdPurchasePrice${t+1}`).prop("readonly",!0),$(`#prdQuantity${t+1}`).prop("readonly",!0),$(`#deleteProductRow${t+1}`).removeClass("cursor-pointer"),$(`#deleteProductRow${t+1}`).addClass("text-muted"))}$("#grandTotal").val(e.grand_total),s($("#grandTotal"))}else{let a=new Date;a.setTime(a.getTime()+7*60*60*1e3);const t=a.toISOString().split(".")[0];console.log(t),$("#purchaseDate").val(t),u()}});$("#supplierId").select2({placeholder:"Pilih Supplier",dropdownParent:$("#supplierId").parent(),ajax:{url:"/master/supplier/get-supplier-list",processResults:function(e){return{results:e.map(function(a){return{id:a.id,text:a.name}})}}},language:{noResults:function(){return"Supplier tidak ditemukan..."}}});$("#supplierId").on("change",function(){$(this).val()!=null&&$("#supplierId").removeClass("invalid")});function u(){p+=1;const e=p,a=m.insertRow(),t=a.insertCell(0),i=a.insertCell(1),d=a.insertCell(2),n=a.insertCell(3),l=a.insertCell(4),v=a.insertCell(5);t.innerHTML=`
    <span id="deleteProductRow${e}" class="d-flex justify-content-center cursor-pointer text-danger" title="Hapus"><i class="ti ti-trash ti-sm"></i></span>
    <input id="poDetailId${e}" name="id" value="0" hidden />
  `,i.innerHTML=`<select id="prdId${e}" name="product_id" class="select2 form-select">`,d.innerHTML=`
    <div class="input-group">
      <span class="input-group-text">Rp</span>
      <input id="prdPurchasePrice${e}" name="purchase_price" value="0" class="form-control" />
    </div>
  `,n.innerHTML=`<input id="prdQuantity${e}" name="quantity" value="0" class="form-control" type="number" min="0" />`,l.innerHTML=`<input id="prdUom${e}" name="uom" class="form-control" readonly />`,v.innerHTML=`
    <div class="input-group">
      <span class="input-group-text">Rp</span>
      <input id="prdTotal${e}" name="total_price" value="0" class="form-control" readonly  />
    </div>  
  `,$(`#prdId${e}`).select2({placeholder:"Pilih Barang",dropdownParent:$(`#prdId${e}`).parent(),ajax:{url:"/inventory/product/get-product-list",processResults:function(o){return{results:o.map(function(r){return{id:r.id,text:r.name,code:r.code,uom:r.uom,purchase_price:r.purchase_price,remarks:r.remarks}})}}},language:{inputTooShort:function(o){return"Mohon input "+(o.minimum-o.input.length)+" karakter lagi. "},noResults:function(){return"Barang tidak ditemukan..."}}}),$(`#deleteProductRow${e}`).on("click",function(){if(!view){const o=$(`#poDetailId${e}`).val();o!=0&&f.push(o),$(this).closest("tr").remove(),h()}}),$(`#prdId${e}`).on("select2:selecting",function(o){const r=o.params.args.data.id;for(var c=1;c<=m.rows.length;c++){const g=$(`#prdId${c}`).val();if(r==g)return toastr.warning("Produk ini telah dipilih, silakan memilih produk lain.","Peringatan",{timeOut:2500}),!1}}),$(`#prdId${e}`).on("select2:select",function(o){const r=o.params.data;$(`#prdPurchasePrice${e}`).val(r.purchase_price),s(`#prdPurchasePrice${e}`),$(`#prdQuantity${e}`).val(0),$(`#prdTotal${e}`).val(0),$(`#prdUom${e}`).val(r.uom)}),`#prdPurchasePrice${e}`&&s(`#prdPurchasePrice${e}`),$(`#prdPurchasePrice${e}, #prdQuantity${e}`).on("keyup change",function(){const r=$(`#prdPurchasePrice${e}`).val().replace(/\./g,"")||0,c=parseFloat($(`#prdQuantity${e}`).val())||0;$(`#prdTotal${e}`).val(r*c),s(`#prdTotal${e}`),h()}),$(`#prdQuantity${e}`).on("change",function(){$(this).val()<0&&($(`#prdQuantity${e}`).val(0),toastr.warning("Qty tidak boleh lebih kecil dari 0.","Peringatan",{timeOut:3500}))})}$("#addProductRowBtn").on("click",function(){u()});$("#submitBtn").on("click",function(){if($("#supplierId").val()==null){toastr.warning("Mohon memilih Supplier","Peringatan",{timeOut:2500}),$("#supplierId").addClass("invalid");return}const e=$("#poForm").serializeArray(),a=[];var t=!0;$("#PODetailTable tbody tr").each(function(){const n={};$(this).find("input, select").each(function(){n[$(this).attr("name")]=$(this).val()}),a.push(n)}),e.push({name:"po_detail",value:a});const i=$("#grandTotal").val().replace(/\./g,"");e.push({name:"grand_total",value:i}),edit&&e.push({name:"deleted_detail",value:f});const d={};e.forEach(function(n){n.name=="po_detail"&&n.value.forEach(l=>{if(l.productId===null||l.purchase_price===""||l.quantity==="0"||l.quantity===""){toastr.warning("Barang, Harga Beli, dan Qty Barang harus diisi.","Peringatan",{timeOut:2500}),t=!1;return}l.purchase_price=l.purchase_price.replace(/\./g,""),l.total_price=l.total_price.replace(/\./g,"")}),d[n.name]=n.value}),t&&fetch($("#poForm").attr("action"),{method:edit?"PUT":"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify(d)}).then(n=>{n.ok?Swal.fire({title:"Success",text:"Data Berhasil Disimpan",icon:"success",customClass:{confirmButton:"btn btn-primary me waves-effect waves-light"}}).then(()=>{window.location.href="/transaction/purchase-order"}):Swal.fire({title:"Error",text:"Data Gagal Disimpan",icon:"error",customClass:{confirmButton:"btn btn-primary me waves-effect waves-light"}})}).catch(n=>{Swal.fire({title:"Error",text:n,icon:"error",customClass:{confirmButton:"btn btn-primary me waves-effect waves-light"}})})});
