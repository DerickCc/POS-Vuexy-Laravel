var m=0,v=0;const f=document.getElementById("soProductDetailTable").getElementsByTagName("tbody")[0],w=document.getElementById("soServiceDetailTable").getElementsByTagName("tbody")[0];function s(e){new Cleave($(e),{numeral:!0,numeralDecimalMark:",",delimiter:".",numeralThousandsGroupStyle:"thousand",numeralDecimalScale:2})}function y(){var i;var e=0,t=0;for(let r=1;r<=m;r++)e+=parseInt((i=$(`#prdTotal${r}`).val())==null?void 0:i.replace(/\./g,""))||0,t+=$(`#prdOriSellingPrice${r}`).val()*parseFloat($(`#prdQuantity${r}`).val())||0;$("#totalProductPrice").val(e),s("#totalProductPrice")}function h(){var t;var e=0;for(let i=1;i<=v;i++)e+=parseInt((t=$(`#svcTotal${i}`).val())==null?void 0:t.replace(/\./g,""))||0;console.log(e),$("#totalServicePrice").val(e),s("#totalServicePrice")}function g(){var a,p;var e=0;for(let l=1;l<=m;l++)e+=$(`#prdOriSellingPrice${l}`).val()*parseFloat($(`#prdQuantity${l}`).val())||0;var t=0;for(let l=1;l<=v;l++)t+=parseInt((a=$(`#svcTotal${l}`).val())==null?void 0:a.replace(/\./g,""))||0;const i=e+t;$("#subTotal").val(i),s("#subTotal");const r=e-parseInt((p=$("#totalProductPrice").val())==null?void 0:p.replace(/\./g,""));$("#discount").val(r),s("#discount");const n=i-r;$("#grandTotal").val(n),s("#grandTotal")}$(function(){const e=view;if(console.log(e),e){$("#customerId").append(`<option value='${e.customer_id.id}'>${e.customer_id.name}</option>`);const r=e.sales_date.split(" ");if($("#salesDate").val(r.join("T")),$("#customerId").prop("disabled",!0),$("#remarks").prop("readonly",!0),$("#paidAmount").prop("readonly",!0),$('input[name="payment_type"]').prop("disabled",!0),$('input[name="payment_type"]').css("opacity",1),e.so_product_detail.length>0){var t=0;e.so_product_detail.forEach((n,a)=>{t+=n.total_price,console.log(n),P(),$(`#soPrdDetail${a+1}`).val(n.id),$(`#prdId${a+1}`).append(`<option value='${n.product_id.id}'>${n.product_id.name}</option>`),$(`#prdOriSellingPrice${a+1}`).val(n.ori_selling_price),$(`#prdSellingPrice${a+1}`).val(n.selling_price),s($(`#prdSellingPrice${a+1}`)),$(`#prdUom${a+1}`).text(n.product_id.uom),$(`#prdQuantity${a+1}`).val(n.quantity),$(`#prdTotal${a+1}`).val(n.total_price),s($(`#prdTotal${a+1}`)),$(`#prdId${a+1}`).prop("disabled",!0),$(`#prdSellingPrice${a+1}`).prop("readonly",!0),$(`#prdQuantity${a+1}`).prop("readonly",!0),$(`#deleteProductRow${a+1}`).removeClass("cursor-pointer"),$(`#deleteProductRow${a+1}`).addClass("text-muted")}),$("#totalProductPrice").val(t)}else $("#soProductDetails").hide();if(e.so_service_detail.length>0){var i=0;e.so_service_detail.forEach((n,a)=>{i+=n.total_price,console.log(n),T(),$(`#soSvcDetail${a+1}`).val(n.id),$(`#svcName${a+1}`).val(n.service_name),$(`#svcSellingPrice${a+1}`).val(n.selling_price),s($(`#svcSellingPrice${a+1}`)),$(`#svcQuantity${a+1}`).val(n.quantity),$(`#svcTotal${a+1}`).val(n.total_price),s($(`#svcTotal${a+1}`)),$(`#svcName${a+1}`).prop("disabled",!0),$(`#svcSellingPrice${a+1}`).prop("readonly",!0),$(`#svcQuantity${a+1}`).prop("readonly",!0),$(`#deleteServiceRow${a+1}`).removeClass("cursor-pointer"),$(`#deleteServiceRow${a+1}`).addClass("text-muted")}),$("#totalServicePrice").val(i)}else $("#soServiceDetails").hide()}else{let r=new Date;r.setTime(r.getTime()+7*60*60*1e3);const n=r.toISOString().split(".")[0];$("#salesDate").val(n)}});$("#customerId").select2({placeholder:"Pilih Customer",dropdownParent:$("#customerId").parent(),ajax:{url:"/master/customer/get-customer-list",processResults:function(e){return{results:e.map(function(t){return{id:t.id,text:t.name}})}}},language:{noResults:function(){return"Customer tidak ditemukan..."}}});$("#customerId").on("change",function(){$(this).val()!=null&&$("#customerId").removeClass("invalid")});function P(){m+=1;const e=m,t=f.insertRow(),i=t.insertCell(0),r=t.insertCell(1),n=t.insertCell(2),a=t.insertCell(3),p=t.insertCell(4);i.innerHTML=`
    <span id="deleteProductRow${e}" class="d-flex justify-content-center cursor-pointer text-danger" title="Hapus"><i class="ti ti-trash ti-sm"></i></span>
    <input hidden id="soPrdDetailId${e}" name="id" value="0" />
  `,r.innerHTML=`<select id="prdId${e}" name="product_id" class="select2 form-select"></select>`,n.innerHTML=`
    <input hidden id="prdOriSellingPrice${e}" name="ori_selling_price" value="0" />
    <div class="input-group">
      <span class="input-group-text">Rp</span>
      <input id="prdSellingPrice${e}" name="selling_price" value="0" class="form-control" />
    </div>
  `,a.innerHTML=`
    <div class="d-flex align-items-center px-0">
      <input id="prdQuantity${e}" name="quantity" value="0" class="form-control me-1 px-1" type="number" min="0" />
      <span id="prdUom${e}"></span>
    </div>
  `,p.innerHTML=`
    <div class="input-group">
      <span class="input-group-text">Rp</span>
      <input id="prdTotal${e}" name="total_price" value="0" class="form-control" readonly  />
    </div>  
  `,$(`#prdId${e}`).select2({placeholder:"Pilih Barang",dropdownParent:$(`#prdId${e}`).parent(),ajax:{url:"/inventory/product/get-product-list",processResults:function(l){return{results:l.map(function(o){return{id:o.id,text:o.name,code:o.code,uom:o.uom,selling_price:o.selling_price,remarks:o.remarks}})}}},language:{inputTooShort:function(l){return"Mohon input "+(l.minimum-l.input.length)+" karakter lagi. "},noResults:function(){return"Barang tidak ditemukan..."}}}),$(`#deleteProductRow${e}`).on("click",function(){view||($(`#soPrdDetailId${e}`).val(),$(this).closest("tr").remove(),y(),g())}),$(`#prdId${e}`).on("select2:selecting",function(l){const o=l.params.args.data.id;for(var d=1;d<=f.rows.length;d++){const u=$(`#prdId${d}`).val();if(o==u)return toastr.warning("Produk ini telah dipilih, silakan memilih produk lain.","Peringatan",{timeOut:2500}),!1}}),$(`#prdId${e}`).on("select2:select",function(l){const o=l.params.data;$(`#prdOriSellingPrice${e}`).val(o.selling_price),$(`#prdSellingPrice${e}`).val(o.selling_price),s(`#prdSellingPrice${e}`),$(`#prdQuantity${e}`).val(0),$(`#prdTotal${e}`).val(0),$(`#prdUom${e}`).text(o.uom)}),`#prdSellingPrice${e}`&&s(`#prdSellingPrice${e}`),$(`#prdSellingPrice${e}, #prdQuantity${e}`).on("keyup change",function(){const o=$(`#prdSellingPrice${e}`).val().replace(/\./g,"")||0,d=parseFloat($(`#prdQuantity${e}`).val())||0;$(`#prdTotal${e}`).val(o*d),s(`#prdTotal${e}`),y(),g(),$("#paidAmount").val(0),$('input[name="payment_type"][value="DP"]').prop("checked",!0)}),$(`#prdQuantity${e}`).on("change",function(){const l=$(`#prdId${e}`).val();if($(`#prdQuantity${e}`).val()<0){$(`#prdQuantity${e}`).val(0),toastr.warning("Qty tidak boleh lebih kecil dari 0.","Peringatan",{timeOut:3500});return}if(l){const o=parseFloat($(`#prdQuantity${e}`).val())||0;$.ajax({url:"/inventory/product/get-product-stock",method:"GET",dataType:"json",data:{id:l},success:function(d){o>d.stock&&(toastr.warning(`Qty melebihi stok yang tersedia, ${d.name} tersisa ${d.stock} ${d.uom}`,"Peringatan",{timeOut:4e3}),$(`#prdQuantity${e}`).val(0).trigger("change"))},error:function(d,u,c){toastr.error("Terjadi Error: "+c,"Error",{timeOut:3500}),console.log(c)}})}})}$("#addProductRowBtn").on("click",function(){P()});function T(){v+=1;const e=v,t=w.insertRow(),i=t.insertCell(0),r=t.insertCell(1),n=t.insertCell(2),a=t.insertCell(3),p=t.insertCell(4);i.innerHTML=`
    <span id="deleteServiceRow${e}" class="d-flex justify-content-center cursor-pointer text-danger" title="Hapus"><i class="ti ti-trash ti-sm"></i></span>
    <input hidden id="soSvcDetailId${e}" name="id" value="0" />
  `,r.innerHTML=`<input id="svcName${e}" name="service_name" class="form-control" />`,n.innerHTML=`
    <div class="input-group">
      <span class="input-group-text">Rp</span>
      <input id="svcSellingPrice${e}" name="selling_price" value="0" class="form-control" />
    </div>
  `,a.innerHTML=`<input id="svcQuantity${e}" name="quantity" value="0" class="form-control" type="number" min="0" />`,p.innerHTML=`
    <div class="input-group">
      <span class="input-group-text">Rp</span>
      <input id="svcTotal${e}" name="total_price" value="0" class="form-control" readonly  />
    </div>  
  `,$(`#deleteServiceRow${e}`).on("click",function(){view||($(`#soSvcDetailId${e}`).val(),$(this).closest("tr").remove(),h(),g())}),`#svcSellingPrice${e}`&&s(`#svcSellingPrice${e}`),$(`#svcSellingPrice${e}, #svcQuantity${e}`).on("keyup change",function(){const o=$(`#svcSellingPrice${e}`).val().replace(/\./g,"")||0,d=parseFloat($(`#svcQuantity${e}`).val())||0;$(`#svcTotal${e}`).val(o*d),s(`#svcTotal${e}`),h(),g(),$("#paidAmount").val(0),$('input[name="payment_type"][value="DP"]').prop("checked",!0)}),$(`#svcQuantity${e}`).on("change",function(){if($(`#svcQuantity${e}`).val()<0){$(`#svcQuantity${e}`).val(0),toastr.warning("Qty tidak boleh lebih kecil dari 0.","Peringatan",{timeOut:3500});return}})}$("#addServiceRowBtn").on("click",function(){T()});$('input[name="payment_type"]').on("change",function(){$(this).val()=="Lunas"?($("#paidAmount").prop("readonly",!0),$("#paidAmount").val($("#grandTotal").val())):($("#paidAmount").prop("readonly",!1),$("#paidAmount").val(0))});$("#subTotal")&&s($("#subTotal"));$("#paidAmount")&&s($("#paidAmount"));$("#paidAmount").on("keyup",function(){const e=+$("#grandTotal").val().replace(/\./g,"");+$(this).val().replace(/\./g,"")>=e&&($(this).val($("#grandTotal").val()),$('input[name="payment_type"][value="Lunas"]').prop("checked",!0),$("#paidAmount").prop("readonly",!0))});$("#submitBtn").on("click",function(){if($("#customerId").val()==null){toastr.warning("Mohon memilih Pelanggan.","Peringatan",{timeOut:2500}),$("#customerId").addClass("invalid");return}const e=$("#soForm").serializeArray(),t=[],i=[];var r=!0;if($("#soProductDetailTable tbody tr").each(function(){const u={};$(this).find("input, select").each(function(){u[$(this).attr("name")]=$(this).val()}),t.push(u)}),$("#soServiceDetailTable tbody tr").each(function(){const u={};$(this).find("input").each(function(){u[$(this).attr("name")]=$(this).val()}),i.push(u)}),t.length==0&&i==0){toastr.warning("Mohon menambahkan minimal 1 Barang/Jasa yang dijual.","Peringatan",{timeOut:2500});return}e.push({name:"so_product_detail",value:t}),e.push({name:"so_service_detail",value:i});const n=$("#grandTotal").val().replace(/\./g,"");e.push({name:"grand_total",value:n});const a=$('input[name="payment_type"]:checked').val();e.push({name:"payment_type",value:a});const p=$("#subTotal").val().replace(/\./g,"");e.push({name:"sub_total",value:p});const l=$("#discount").val().replace(/\./g,"");e.push({name:"discount",value:l});const o=$("#paidAmount").val().replace(/\./g,"");e.push({name:"paid_amount",value:o});const d={};e.forEach(function(u){u.name=="so_product_detail"?u.value.forEach(c=>{if(c.productId===null||c.selling_price===""||c.quantity==="0"||c.quantity===""){toastr.warning("Barang, Harga Jual, dan Qty Barang harus diisi.","Peringatan",{timeOut:2500}),r=!1;return}c.ori_selling_price=c.ori_selling_price.replace(/\./g,""),c.selling_price=c.selling_price.replace(/\./g,""),c.total_price=c.total_price.replace(/\./g,"")}):u.name=="so_service_detail"&&u.value.forEach(c=>{if(c.serviceName===null||c.quantity==="0"||c.quantity===""){toastr.warning("Nama Jasa dan Qty Jasa harus diisi.","Peringatan",{timeOut:2500}),r=!1;return}c.selling_price=c.selling_price.replace(/\./g,""),c.total_price=c.total_price.replace(/\./g,"")}),d[u.name]=u.value}),console.log(d),r&&fetch($("#soForm").attr("action"),{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify(d)}).then(u=>{u.ok?Swal.fire({title:"Success",text:"Data Berhasil Disimpan",icon:"success",customClass:{confirmButton:"btn btn-primary me waves-effect waves-light"}}).then(()=>{window.location.href="/transaction/sales-order"}):Swal.fire({title:"Error",text:"Data Gagal Disimpan",icon:"error",customClass:{confirmButton:"btn btn-primary me waves-effect waves-light"}})}).catch(u=>{Swal.fire({title:"Error",text:u,icon:"error",customClass:{confirmButton:"btn btn-primary me waves-effect waves-light"}})})});$(document).on("click","#openPaymentModalBtn",function(){var e=view.so_code,t=view.grand_total,i=view.paid_amount;$("#soCodeM").val(e),$("#grandTotalM").val(t),$("#paidAmountM").val(i),$("#shouldBePaidM").val(t-i),s("#grandTotalM"),s("#paidAmountM"),s("#shouldBePaidM"),s("#paymentAmountM"),$("#paymentAmountM").on("keyup change",function(){const r=$(this).val().replace(/\./g,"");if(r>t-i){$("#paymentAmountM").val($("#shouldBePaidM").val());return}else if(r<0){$("#paymentAmountM").val(0);return}$("#paymentLeftM").val(t-i-r),s("#paymentLeftM")}),$("#paymentModal").modal("show")});$("#submitPaymentModalBtn").on("click",function(){Swal.fire({title:"Cek Sekali Lagi!",text:"Pastikan jumlah yang dibayarkan telah sesuai.",icon:"warning",confirmButtonText:"Simpan",customClass:{confirmButton:"btn btn-warning me-3 waves-effect waves-light",cancelButton:"btn btn-label-secondary waves-effect waves-light"}}).then(e=>{if(e.isConfirmed){const t=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),i=$("#paymentAmountM").val().replace(/\./g,""),r=view.id;$.ajax({url:`/transaction/sales-order/${r}/update-paid-amount`,type:"PUT",headers:{"X-CSRF-TOKEN":t},data:{paid_amount:i},success:function(n){$("#paymentModal").modal("hide"),Swal.fire({title:"Success",text:"Pembayaran Berhasil Disimpan",icon:"success",customClass:{confirmButton:"btn btn-primary me waves-effect waves-light"}}).then(()=>{history.back()})},error:function(n,a,p){Swal.fire({title:"Error",text:p,icon:"error",customClass:{confirmButton:"btn btn-primary me waves-effect waves-light"}})}})}})});
